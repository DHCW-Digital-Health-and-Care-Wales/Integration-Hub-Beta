# Improved Release Pipeline with Dynamic Stage Generation
# This pipeline uses configuration files and loops to reduce repetition

trigger: none
pr: none

parameters:
  - name: selectedApp
    displayName: 'Select Application to Deploy (or "all" for all apps)'
    type: string
    default: 'all'
    values:
      - 'all'
      - 'PHW HL7Server'
      - 'PIMS HL7Server'
      - 'Paris HL7Server'
      - 'Chemocare HL7Server'
      - 'MPI HL7Server'
      - 'HL7 Phw Transformer'
      - 'HL7 Chemo Transformer'
      - 'HL7 Pims Transformer'
      - 'HL7 Sender'
      - 'PIMS HL7 Sender'
      - 'Chemocare HL7 Sender'
      - 'HL7 Mock Receiver'
      
  - name: selectedEnvironment
    displayName: 'Select Environment to Deploy (or "all" for all environments)'
    type: string
    default: 'all'
    values:
      - 'all'
      - 'dev'
      - 'dte'
      - 'tst'
      - 'ppd'
      - 'prd'

variables:
  # Shared Configuration
  - name: acrName
    value: 'uksdhcwihsharedcr'
  - name: azureServiceConnection
    value: 'Azure - NHSWales-DHCW-IntegrationHub-Subscription'
  - name: azureLocation
    value: 'uks'
    
  # Pool Configuration
  - name: POOL_NAME_NON_PROD
    value: 'UKS-DHCW-IH-DEV-ADOManagedPool'
  - name: POOL_NAME_PROD
    value: 'UKS-DHCW-IH-PPD-ADOManagedPool'
    
  # Load application configuration from external file
  - name: appsConfig
    value: $[ stageDependencies.LoadConfig.LoadConfigJob.outputs['loadConfig.appsConfig'] ]
  - name: environmentsConfig
    value: $[ stageDependencies.LoadConfig.LoadConfigJob.outputs['loadConfig.environmentsConfig'] ]

resources:
  pipelines:
    - pipeline: 'HL7 Server - Build'
      source: 'HL7 Server - Build'
      trigger: none
    - pipeline: 'HL7 Phw Transformer - Build'
      source: 'HL7 Phw Transformer - Build'
      trigger: none
    - pipeline: 'HL7 Chemo Transformer - Build'
      source: 'HL7 Chemo Transformer - Build'
      trigger: none
    - pipeline: 'HL7 Pims Transformer - Build'
      source: 'HL7 Pims Transformer - Build'
      trigger: none
    - pipeline: 'HL7 Sender - Build'
      source: 'HL7 Sender - Build'
      trigger: none
    - pipeline: 'HL7 Mock Receiver - Build'
      source: 'HL7 Mock Receiver - Build'
      trigger: none

stages:
  # Define applications metadata inline (can be moved to a separate file later)
  - template: templates/dynamic-stages-template.yml
    parameters:
      selectedApp: ${{ parameters.selectedApp }}
      selectedEnvironment: ${{ parameters.selectedEnvironment }}
      azureLocation: $(azureLocation)
      acrName: $(acrName)
      azureServiceConnection: $(azureServiceConnection)
      
      # Application configurations
      appConfig:
        # HL7 Server Variants
        - name: 'PHW HL7Server'
          appName: 'hl7server'
          appFunctionMidfix: 'phw'
          buildPipeline: 'HL7 Server - Build'
          
        - name: 'PIMS HL7Server'
          appName: 'hl7server'
          appFunctionMidfix: 'pims'
          buildPipeline: 'HL7 Server - Build'
          
        - name: 'Paris HL7Server'
          appName: 'hl7server'
          appFunctionMidfix: 'paris'
          buildPipeline: 'HL7 Server - Build'
          
        - name: 'Chemocare HL7Server'
          appName: 'hl7server'
          appFunctionMidfix: 'chemo'
          buildPipeline: 'HL7 Server - Build'
          
        - name: 'MPI HL7Server'
          appName: 'hl7server'
          appFunctionMidfix: 'mpi'
          buildPipeline: 'HL7 Server - Build'

        # HL7 Transformer Variants
        - name: 'HL7 Phw Transformer'
          appName: 'phw-hl7transformer'
          appFunctionMidfix: ''
          buildPipeline: 'HL7 Phw Transformer - Build'
          
        - name: 'HL7 Chemo Transformer'
          appName: 'chemo-hl7transformer'
          appFunctionMidfix: ''
          buildPipeline: 'HL7 Chemo Transformer - Build'
          
        - name: 'HL7 Pims Transformer'
          appName: 'pims-hl7transformer'
          appFunctionMidfix: ''
          buildPipeline: 'HL7 Pims Transformer - Build'

        # HL7 Sender Variants
        - name: 'HL7 Sender'
          appName: 'hl7sender'
          appFunctionMidfix: ''
          buildPipeline: 'HL7 Sender - Build'
          
        - name: 'PIMS HL7 Sender'
          appName: 'hl7sender'
          appFunctionMidfix: 'pims'
          buildPipeline: 'HL7 Sender - Build'
          
        - name: 'Chemocare HL7 Sender'
          appName: 'hl7sender'
          appFunctionMidfix: 'chemo'
          buildPipeline: 'HL7 Sender - Build'

        # Mock Receiver
        - name: 'HL7 Mock Receiver'
          appName: 'hl7mockreceiver'
          appFunctionMidfix: ''
          buildPipeline: 'HL7 Mock Receiver - Build'
      
      # Environment configurations
      environments:
        - name: 'dev'
          displayName: 'Development'
          resourceGroup: 'UK-South-DHCW-IntHub-DEV-RG'
          poolName: 'POOL_NAME_NON_PROD'
          dependsOnPrevious: false
          
        - name: 'dte'
          displayName: 'DTE'
          resourceGroup: 'UK-South-DHCW-IntHub-DTE-RG'
          poolName: 'POOL_NAME_NON_PROD'
          dependsOnPrevious: true
          
        - name: 'tst'
          displayName: 'Test'
          resourceGroup: 'UK-South-DHCW-IntHub-TST-RG'
          poolName: 'POOL_NAME_NON_PROD'
          dependsOnPrevious: true
          
        - name: 'ppd'
          displayName: 'Pre-Production'
          resourceGroup: 'UK-South-DHCW-IntHub-PPD-RG'
          poolName: 'POOL_NAME_PROD'
          dependsOnPrevious: true
          
        - name: 'prd'
          displayName: 'Production'
          resourceGroup: 'UK-South-DHCW-IntHub-PRD-RG'
          poolName: 'POOL_NAME_PROD'
          dependsOnPrevious: true
