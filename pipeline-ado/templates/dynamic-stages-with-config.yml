# Dynamic Stages Template with External Configuration
# This template loads app and environment configurations from apps-config.yml

parameters:
  - name: selectedApp
    type: string
    default: 'all'
  - name: selectedEnvironment
    type: string
    default: 'all'
  - name: azureLocation
    type: string
  - name: acrName
    type: string
  - name: azureServiceConnection
    type: string
  - name: config
    type: object

stages:
  # Loop through each environment from config file
  - ${{ each env in parameters.config.environments }}:
    # Check if environment is selected
    - ${{ if or(eq(parameters.selectedEnvironment, 'all'), eq(parameters.selectedEnvironment, env.name)) }}:
      # Loop through each application from config file
      - ${{ each app in parameters.config.applications }}:
        # Check if app is selected
        - ${{ if or(eq(parameters.selectedApp, 'all'), eq(parameters.selectedApp, app.name)) }}:
          - stage: Release_${{ replace(replace(app.name, ' ', ''), '-', '') }}_${{ upper(env.name) }}
            displayName: 'Release ${{ app.name }} - ${{ env.displayName }}'
            
            # Set up dependencies based on environment configuration
            # Only add dependencies if 'all' environments are selected to maintain the chain
            ${{ if and(eq(env.dependsOnPrevious, true), eq(parameters.selectedEnvironment, 'all')) }}:
              ${{ if eq(env.name, 'dte') }}:
                dependsOn: Release_${{ replace(replace(app.name, ' ', ''), '-', '') }}_DEV
              ${{ elseif eq(env.name, 'tst') }}:
                dependsOn: Release_${{ replace(replace(app.name, ' ', ''), '-', '') }}_DTE
              ${{ elseif eq(env.name, 'uat') }}:
                dependsOn: Release_${{ replace(replace(app.name, ' ', ''), '-', '') }}_TST
              ${{ elseif eq(env.name, 'ppd') }}:
                dependsOn: Release_${{ replace(replace(app.name, ' ', ''), '-', '') }}_UAT
              ${{ elseif eq(env.name, 'prd') }}:
                dependsOn: Release_${{ replace(replace(app.name, ' ', ''), '-', '') }}_PPD
            ${{ else }}:
              dependsOn: []
            
            jobs:
              - template: release-container-app-template.yml
                parameters:
                  # Job Configuration
                  jobName: Deploy_${{ replace(replace(app.name, ' ', ''), '-', '') }}
                  displayName: Deploy ${{ app.name }} to ${{ env.displayName }}
                  
                  # Environment Information
                  environment: ${{ env.name }}
                  azureLocation: ${{ parameters.azureLocation }}
                  resourceGroupName: ${{ env.resourceGroup }}
                  
                  # Application Information
                  appName: ${{ app.appName }}
                  appFunctionMidfix: ${{ app.appFunctionMidfix }}
                  
                  # Container Registry
                  acrName: ${{ parameters.acrName }}
                  acrRepository: ${{ app.appName }}
                  
                  # Azure Configuration
                  azureServiceConnection: ${{ parameters.azureServiceConnection }}
                  
                  # Pool Configuration
                  POOL_NAME: ${{ variables[env.poolName] }}
                  
                  # Build Pipeline Information
                  resourcePipelineName: ${{ app.buildPipeline }}
